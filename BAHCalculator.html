<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M9GS3PQFCV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-M9GS3PQFCV');
    </script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Spark | Housing Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'zinc-950': '#09090b', 'zinc-900': '#18181b', 'zinc-800': '#27272a',
                        'zinc-700': '#3f3f46', 'purple-600': '#9333ea', 'purple-500': '#a855f7',
                        'purple-400': '#c084fc', 'emerald-500': '#10b981', 'emerald-400': '#34d399',
                        'red-400': '#f87171',
                    }
                }
            }
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #3f3f46; border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #3f3f46; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        
        /* THICKER THUMB (GRABBER) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; 
            height: 24px; /* Increased from 16px */
            width: 24px;  /* Increased from 16px */
            border-radius: 50%; 
            background: #a855f7; 
            cursor: pointer;
            margin-top: -7px; /* Aligns center of thumb to center of track */
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.2); }

        /* THICKER TRACK */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; 
            height: 10px; /* Increased from 4px */
            cursor: pointer;
            background: #e4e4e7; 
            border-radius: 5px; /* Rounded edges */
        }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #27272a; }
        
        .utility-slider::-webkit-slider-thumb { background: #10b981; }
        .interest-slider::-webkit-slider-thumb { background: #f59e0b; }
        input, select { font-size: 16px !important; }
    </style>
</head>
<body class="min-h-screen bg-zinc-50 text-zinc-900 dark:bg-zinc-950 dark:text-zinc-200 font-sans transition-colors duration-300">
    
    <header class="border-b border-zinc-200 dark:border-zinc-800 bg-white/80 dark:bg-zinc-900/50 backdrop-blur-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <a href="https://royal-spark.github.io/Landing-Page/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <img src="https://dwtymuzolmglgyejxuve.supabase.co/storage/v1/object/public/podcasts//Royal%20Spark%20D%20Logo%20-%20Mekvold%20V3.png" alt="Royal Spark Logo" class="w-8 h-8 rounded shadow-lg shadow-purple-500/20">
                <h1 class="font-semibold text-lg text-zinc-900 dark:text-zinc-100">Royal Spark <span class="text-zinc-500 font-normal">| Housing Planner</span></h1>
            </a>
            <div class="flex items-center gap-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-500 dark:text-zinc-400 transition-colors">
                    <svg id="sun-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moon-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8 space-y-8">
        
        <div class="flex justify-center">
            <div class="bg-zinc-200 dark:bg-zinc-800 p-1 rounded-xl flex gap-1">
                <button id="btn-conus" onclick="setRegion('conus')" class="px-6 py-2 rounded-lg text-sm font-bold shadow-sm bg-white dark:bg-zinc-700 text-zinc-900 dark:text-white transition-all">CONUS (BAH)</button>
                <button id="btn-oconus" onclick="setRegion('oconus')" class="px-6 py-2 rounded-lg text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-200 transition-all">Overseas (OHA)</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5 space-y-6">
                <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-2xl p-6 shadow-xl dark:shadow-none space-y-6 relative transition-colors duration-300">
                    <div id="loading-overlay" class="absolute inset-0 bg-white/90 dark:bg-zinc-900/90 z-50 rounded-2xl flex flex-col items-center justify-center transition-colors duration-300">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mb-2"></div>
                        <span class="text-sm text-zinc-500 dark:text-zinc-400" id="loading-text">Loading 2025 Rates...</span>
                    </div>

                    <div class="flex items-center gap-2 text-purple-600 dark:text-purple-400 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span class="text-xs font-bold uppercase tracking-wider">Configuration</span>
                    </div>

                    <div class="relative" id="dropdown-container">
                        <label class="block text-sm font-medium text-zinc-600 dark:text-zinc-400 mb-1.5">Duty Station</label>
                        <div class="relative">
                            <input type="text" id="mha-search-input" autocomplete="off" class="w-full bg-zinc-50 dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-xl pl-4 pr-10 py-3 text-zinc-900 dark:text-white placeholder-zinc-400 dark:placeholder-zinc-600 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all" placeholder="Search base or city..." disabled>
                            
                            <button id="clear-search-btn" class="absolute right-8 top-3.5 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-200 hidden" onclick="clearSearch()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>

                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute right-2 top-3.5 w-5 h-5 text-zinc-400 dark:text-zinc-600 pointer-events-none"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div id="mha-dropdown" class="absolute left-0 right-0 mt-2 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl shadow-2xl max-h-64 overflow-y-auto z-50 custom-scrollbar hidden"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-zinc-600 dark:text-zinc-400 mb-1.5">Pay Grade</label>
                            <select id="rank-select" class="w-full appearance-none bg-zinc-50 dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 rounded-xl px-4 py-3 text-zinc-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-zinc-600 dark:text-zinc-400 mb-1.5">Dependents?</label>
                            <button id="dependents-toggle" class="w-full h-[48px] rounded-xl px-1 py-1 flex items-center relative transition-colors duration-300 border bg-purple-100 dark:bg-purple-900/20 border-purple-500/30">
                                <div class="flex w-full justify-between px-4 text-xs font-bold z-10">
                                    <span class="text-zinc-400 dark:text-zinc-500">NO</span>
                                    <span class="text-purple-900 dark:text-white">YES</span>
                                </div>
                                <div id="dependents-slider" class="absolute top-1 bottom-1 w-[calc(50%-4px)] rounded-lg bg-purple-600 transition-all duration-300 shadow-sm translate-x-[100%]"></div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7 space-y-6">
                <div class="relative overflow-hidden bg-gradient-to-br from-purple-800 to-zinc-800 dark:from-purple-900 dark:to-zinc-900 border border-purple-500/20 rounded-2xl p-8 text-center shadow-2xl transition-colors duration-300">
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" style="background-image: radial-gradient(circle at 50% 50%, #a855f7 1px, transparent 1px); background-size: 24px 24px;"></div>
                    
                    <h3 class="text-purple-200 font-medium text-sm uppercase tracking-widest mb-2" id="allowance-label">Monthly Allowance</h3>
                    
                    <div class="text-5xl md:text-6xl font-bold text-white tracking-tight" id="bah-display">$0</div>
                    
                    <div id="oha-secondary-display" class="hidden text-xl font-medium text-purple-200 mt-1">$0 USD</div>
                    
                    <div class="mt-3 text-purple-200/80 text-sm" id="info-display">Select a location</div>
                </div>

                <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-2xl p-6 shadow-xl dark:shadow-none space-y-6 transition-colors duration-300">
                    
                    <div id="calc-mode-tabs" class="flex border-b border-zinc-100 dark:border-zinc-800 pb-4 mb-4">
                        <button id="mode-rent" onclick="setCalculatorMode('rent')" class="flex-1 pb-2 text-sm font-bold text-purple-600 border-b-2 border-purple-600 transition-colors">RENTING</button>
                        <button id="mode-buy" onclick="setCalculatorMode('buy')" class="flex-1 pb-2 text-sm font-medium text-zinc-400 border-b-2 border-transparent hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors">BUYING</button>
                    </div>

                    <div id="inputs-rent" class="space-y-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-end">
                                <label class="flex items-center gap-2 text-sm font-medium text-zinc-600 dark:text-zinc-300">
                                    <span id="rent-label-text">Monthly Rent</span>
                                </label>
                                <div class="text-xl font-bold text-zinc-900 dark:text-white bg-zinc-50 dark:bg-zinc-950 px-3 py-1 rounded border border-zinc-200 dark:border-zinc-800" id="rent-display">$0</div>
                            </div>
                            <input type="range" id="rent-slider" min="0" max="5000" step="50" value="0" class="w-full">
                        </div>
                    </div>

                    <div id="inputs-buy" class="space-y-6 hidden">
                        <div class="space-y-4">
                            <div class="flex justify-between items-end">
                                <label class="text-sm font-medium text-zinc-600 dark:text-zinc-300">Home Price</label>
                                <div class="text-xl font-bold text-zinc-900 dark:text-white bg-zinc-50 dark:bg-zinc-950 px-3 py-1 rounded" id="price-display">$350,000</div>
                            </div>
                            <input type="range" id="price-slider" min="50000" max="1000000" step="1000" value="350000" class="w-full">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><label class="text-xs font-medium text-zinc-500">Interest Rate</label><span class="text-sm font-bold text-amber-500" id="rate-display">6.5%</span></div>
                                <input type="range" id="rate-slider" min="2.0" max="10.0" step="0.1" value="6.5" class="w-full interest-slider">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><label class="text-xs font-medium text-zinc-500">Down Payment</label><span class="text-sm font-bold text-zinc-700 dark:text-zinc-300" id="down-display">$0</span></div>
                                <input type="range" id="down-slider" min="0" max="100000" step="1000" value="0" class="w-full">
                            </div>
                        </div>
                        <div class="bg-purple-50 dark:bg-zinc-800/50 border border-purple-100 dark:border-zinc-700 rounded-xl p-4 flex justify-between items-center">
                            <div><p class="text-xs font-bold text-purple-600 dark:text-purple-400 uppercase">Est. Mortgage</p><p id="est-mortgage-main" class="text-xl font-bold text-zinc-900 dark:text-white">$0/mo</p></div>
                        </div>
                    </div>

                    <div class="space-y-4 pt-2" id="utility-block">
                        <div class="flex justify-between items-end">
                            <label class="text-sm font-medium text-zinc-600 dark:text-zinc-300">Est. Utilities</label>
                            <div class="text-xl font-bold text-zinc-900 dark:text-white bg-zinc-50 dark:bg-zinc-950 px-3 py-1 rounded" id="utilities-display">$250</div>
                        </div>
                        <input type="range" id="utilities-slider" min="0" max="1000" step="10" value="250" class="w-full utility-slider">
                    </div>

                    <div id="oha-breakdown" class="hidden grid grid-cols-2 gap-4 pt-2">
                        <div class="bg-emerald-50 dark:bg-emerald-900/10 border border-emerald-100 dark:border-emerald-800/30 p-3 rounded-xl">
                            <p class="text-[10px] font-bold uppercase text-emerald-600 dark:text-emerald-400 tracking-wider">Utility Allowance</p>
                            <p class="text-lg font-bold text-zinc-900 dark:text-white" id="oha-util-disp">$0</p>
                            <p class="text-xs text-zinc-500">Monthly (Keep if unused)</p>
                        </div>
                        <div class="bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-800/30 p-3 rounded-xl">
                            <p class="text-[10px] font-bold uppercase text-blue-600 dark:text-blue-400 tracking-wider">MIHA</p>
                            <p class="text-lg font-bold text-zinc-900 dark:text-white" id="oha-miha-disp">$0</p>
                            <p class="text-xs text-zinc-500">One-time payment</p>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-zinc-100 dark:border-zinc-800">
                         <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-zinc-500 dark:text-zinc-400">Net Monthly Impact</span>
                            <span id="remaining-text" class="text-sm font-medium text-emerald-500 dark:text-emerald-400">Under Budget</span>
                         </div>
                         <div id="result-bar" class="w-full p-4 rounded-xl flex items-center justify-between border bg-emerald-50 dark:bg-emerald-900/10 border-emerald-200 dark:border-emerald-500/20 transition-colors">
                             <div class="flex items-center gap-3">
                                <div id="result-icon-container" class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-500/20 flex items-center justify-center text-emerald-600 dark:text-emerald-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-xs text-zinc-500 uppercase font-bold tracking-wider">Remaining</span>
                                    <span id="remaining-display" class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">$0</span>
                                </div>
                             </div>
                         </div>
                    </div>
					<div class="bg-blue-50 dark:bg-zinc-900/50 border border-blue-100 dark:border-zinc-800/50 rounded-xl p-4 flex gap-3 items-start">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-500 dark:text-blue-400 mt-0.5 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-zinc-800 dark:text-zinc-300">2025 Housing Data</p>
                        <p class="text-xs text-zinc-600 dark:text-zinc-500">Official entitlements should be verified with finance.</p>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
    const BAH_WITH_URL = "https://raw.githubusercontent.com/Royal-Spark/Landing-Page/main/With.csv";
    const BAH_WITHOUT_URL = "https://raw.githubusercontent.com/Royal-Spark/Landing-Page/main/Without.csv";
    const OHA_URL = "https://raw.githubusercontent.com/Royal-Spark/Landing-Page/main/MasterOHA.csv";
    
    const CURRENCY_SYMBOLS = {
        "United Kingdom": "£", "Germany": "€", "Italy": "€", "France": "€",
        "Spain": "€", "Belgium": "€", "Netherlands": "€", "Portugal": "€", 
        "Greece": "€", "Turkey": "₺", "Japan": "¥", "Korea": "₩", 
        "Bahrain": "BHD", "Australia": "A$", "Canada": "C$", "Denmark": "kr",
        "Norway": "kr", "Poland": "zł", "Romania": "lei", "Hungary": "Ft",
        "Singapore": "S$", "Thailand": "฿", "Philippines": "₱"
    };

    const RANKS = [
        { label: "E-1", value: "E01" }, { label: "E-2", value: "E02" }, { label: "E-3", value: "E03" },
        { label: "E-4", value: "E04" }, { label: "E-5", value: "E05" }, { label: "E-6", value: "E06" },
        { label: "E-7", value: "E07" }, { label: "E-8", value: "E08" }, { label: "E-9", value: "E09" },
        { label: "W-1", value: "W01" }, { label: "W-2", value: "W02" }, { label: "W-3", value: "W03" },
        { label: "W-4", value: "W04" }, { label: "W-5", value: "W05" },
        { label: "O-1E", value: "O01E" }, { label: "O-2E", value: "O02E" }, { label: "O-3E", value: "O03E" },
        { label: "O-1", value: "O01" }, { label: "O-2", value: "O02" }, { label: "O-3", value: "O03" },
        { label: "O-4", value: "O04" }, { label: "O-5", value: "O05" }, { label: "O-6", value: "O06" },
    ];

    let REGION = 'conus';
    let DATA_BAH = [], DATA_OHA = [];
    let selectedLocation = null;
    let selectedRank = "E05";
    let hasDependents = true;
    let mode = 'rent';
    let rent = 0, utilities = 250;
    let homePrice = 350000, interestRate = 6.5, downPayment = 0;

    const getSymbol = () => {
        if (REGION === 'conus') return '$';
        if (selectedLocation && selectedLocation.country) {
            return CURRENCY_SYMBOLS[selectedLocation.country] || '¤';
        }
        return '¤';
    };

    const formatCurrency = (val, type = 'USD') => {
        if (type === 'LOCAL') {
            const sym = getSymbol();
            return sym + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(val);
        }
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
    };

    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 2) return [];
        return lines.map(line => line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/^"|"$/g, '')));
    }

    async function initializeData() {
        try {
            const [withRes, withoutRes, ohaRes] = await Promise.all([
                fetch(BAH_WITH_URL), fetch(BAH_WITHOUT_URL), fetch(OHA_URL)
            ]);
            const wTxt = await withRes.text();
            const woTxt = await withoutRes.text();
            const ohaTxt = await ohaRes.text();

            processBAH(wTxt, woTxt);
            processOHA(ohaTxt);
            
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('mha-search-input').disabled = false;
        } catch (err) {
            console.error(err);
            document.getElementById('loading-text').textContent = "Error loading data.";
        }
    }

    function processBAH(withTxt, withoutTxt) {
        const wRows = parseCSV(withTxt);
        const woRows = parseCSV(withoutTxt);
        let wHeadIdx = wRows.findIndex(r => r[0].includes('MHA_NAME'));
        let wHeaders = wRows[wHeadIdx];
        const combined = [];
        for(let i = wHeadIdx + 1; i < wRows.length; i++) {
            const row = wRows[i];
            if(row.length < 2) continue;
            const name = row[0];
            const ratesW = {}, ratesWO = {};
            wHeaders.forEach((h, idx) => { if(idx > 0) ratesW[h] = parseInt(row[idx]) || 0; });
            const woRow = woRows.find(r => r[0] === name);
            if(woRow) wHeaders.forEach((h, idx) => { if(idx > 0) ratesWO[h] = parseInt(woRow[idx]) || 0; });
            combined.push({ name: name, rates: { with: ratesW, without: ratesWO } });
        }
        DATA_BAH = combined;
    }

    function processOHA(csvText) {
        const rows = parseCSV(csvText);
        const data = [];
        for(let i = 1; i < rows.length; i++) {
            const r = rows[i];
            if(r.length < 8) continue;
            data.push({
                country: r[0], location: r[1], rank: r[3],
                rentWith: parseFloat(r[4]) || 0,
                rentWithout: parseFloat(r[5]) || 0,
                utility: parseFloat(r[6]) || 0,
                miha: parseFloat(r[7]) || 0,
                rate: parseFloat(r[8]) || 1.0
            });
        }
        DATA_OHA = data;
    }

    function setRegion(reg) {
        REGION = reg;
        const btnConus = document.getElementById('btn-conus');
        const btnOconus = document.getElementById('btn-oconus');
        const bahLabel = document.getElementById('allowance-label');
        const rentLabel = document.getElementById('rent-label-text');
        const utilBlock = document.getElementById('utility-block');
        const ohaBlock = document.getElementById('oha-breakdown');
        const secDisp = document.getElementById('oha-secondary-display');

        if (reg === 'conus') {
            btnConus.className = "px-6 py-2 rounded-lg text-sm font-bold shadow-sm bg-white dark:bg-zinc-700 text-zinc-900 dark:text-white transition-all";
            btnOconus.className = "px-6 py-2 rounded-lg text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-200 transition-all";
            bahLabel.textContent = "Monthly Allowance (BAH)";
            rentLabel.textContent = "Monthly Rent";
            utilBlock.classList.remove('hidden');
            ohaBlock.classList.add('hidden');
            secDisp.classList.add('hidden');
            document.getElementById('calc-mode-tabs').classList.remove('hidden');
        } else {
            btnOconus.className = "px-6 py-2 rounded-lg text-sm font-bold shadow-sm bg-white dark:bg-zinc-700 text-zinc-900 dark:text-white transition-all";
            btnConus.className = "px-6 py-2 rounded-lg text-sm font-medium text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-200 transition-all";
            bahLabel.textContent = "Max Rental Allowance (OHA)";
            rentLabel.textContent = "Rent (Local Currency)";
            utilBlock.classList.add('hidden');
            ohaBlock.classList.remove('hidden');
            secDisp.classList.remove('hidden');
            document.getElementById('calc-mode-tabs').classList.add('hidden');
            setCalculatorMode('rent');
        }
        clearSearch();
        updateDisplay();
    }

    function updateDisplay() {
        if(REGION === 'conus') updateBAH(); else updateOHA();
    }

    function updateBAH() {
        let amount = 0;
        if (selectedLocation) {
            const type = hasDependents ? 'with' : 'without';
            amount = selectedLocation.rates[type][selectedRank] || 0;
        }
        document.getElementById('bah-display').textContent = formatCurrency(amount);
        document.getElementById('info-display').textContent = selectedLocation ? `${selectedLocation.name} • ${selectedRank}` : "Select a location";

        const slider = document.getElementById('rent-slider');
        if(slider.max > 10000) { slider.max = 5000; slider.value = 0; rent = 0; } 

        let cost = 0;
        
        if (mode === 'rent') {
            cost = rent + utilities;
            document.getElementById('rent-display').textContent = formatCurrency(rent);
        } else {
            // Standard Mortgage Formula: M = P [ i(1 + i)^n ] / [ (1 + i)^n – 1 ]
            const principal = homePrice - downPayment;
            const monthlyRate = interestRate / 100 / 12;
            const numPayments = 360; // 30 Years Fixed
            
            let mortgage = 0;
            if (principal > 0) {
                if (monthlyRate === 0) {
                    mortgage = principal / numPayments;
                } else {
                    mortgage = principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                }
            }
            
            document.getElementById('est-mortgage-main').textContent = formatCurrency(mortgage) + "/mo";
            // Homeowners also pay utilities
            cost = mortgage + utilities;
        }

        updateResult(amount - cost, amount, cost, true);
    }

    function updateOHA() {
        let rentCap = 0, util = 0, miha = 0, rate = 1.0;
        
        if (selectedLocation) {
            const simpleRank = selectedRank.replace(/0/g, ''); 
            const row = DATA_OHA.find(d => d.country === selectedLocation.country && d.location === selectedLocation.location && d.rank === simpleRank);
            
            if (row) {
                rentCap = hasDependents ? row.rentWith : row.rentWithout;
                util = row.utility;
                miha = row.miha;
                rate = row.rate;
            }
        }

        const slider = document.getElementById('rent-slider');
        const newMax = rentCap > 0 ? rentCap * 2 : 5000;
        if(Math.abs(slider.max - newMax) > 100) {
            slider.max = newMax;
            if(selectedLocation && rent === 0) { 
                slider.value = rentCap;
                rent = rentCap;
            }
        }

        document.getElementById('bah-display').textContent = formatCurrency(rentCap, 'LOCAL');
        
        let usdVal = (rate > 10) ? rentCap / rate : rentCap * rate;
        document.getElementById('oha-secondary-display').textContent = `≈ ${formatCurrency(usdVal)}`;
        
        document.getElementById('info-display').textContent = selectedLocation ? `${selectedLocation.location}, ${selectedLocation.country}` : "Select a location";
        
        let utilUSD = (rate > 10) ? util / rate : util * rate;
        let mihaUSD = (rate > 10) ? miha / rate : miha * rate;
        
        document.getElementById('oha-util-disp').textContent = formatCurrency(utilUSD);
        document.getElementById('oha-miha-disp').textContent = formatCurrency(mihaUSD);
        document.getElementById('rent-display').textContent = formatCurrency(rent, 'LOCAL');

        let overCapLocal = Math.max(0, rent - rentCap);
        let overCapUSD = (rate > 10) ? overCapLocal / rate : overCapLocal * rate;
        
        updateResult(-overCapUSD, usdVal, overCapUSD, false);
    }

    function updateResult(diff, allow, cost, isBAH) {
        const bar = document.getElementById('result-bar');
        const val = document.getElementById('remaining-display');
        const label = document.getElementById('remaining-text');
        const icon = document.getElementById('result-icon-container');

        bar.className = "w-full p-4 rounded-xl flex items-center justify-between border transition-colors";
        
        if (diff >= -0.99) { 
            bar.classList.add('bg-emerald-50', 'dark:bg-emerald-900/10', 'border-emerald-200', 'dark:border-emerald-500/20');
            val.className = "text-2xl font-bold text-emerald-600 dark:text-emerald-400";
            label.textContent = isBAH ? "Under Budget" : "Fully Covered";
            label.className = "text-sm font-medium text-emerald-500";
            icon.className = "w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-500/20 flex items-center justify-center text-emerald-600";
            icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            val.textContent = isBAH ? formatCurrency(diff) : "$0"; 
        } else {
            bar.classList.add('bg-red-50', 'dark:bg-red-900/10', 'border-red-200', 'dark:border-red-500/20');
            val.className = "text-2xl font-bold text-red-500 dark:text-red-400";
            label.textContent = "Out of Pocket";
            label.className = "text-sm font-medium text-red-500";
            icon.className = "w-10 h-10 rounded-full bg-red-100 dark:bg-red-500/20 flex items-center justify-center text-red-500";
            icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            val.textContent = formatCurrency(diff);
        }
    }

    const mhaInput = document.getElementById('mha-search-input');
    const mhaDropdown = document.getElementById('mha-dropdown');
    const clearBtn = document.getElementById('clear-search-btn');

    function clearSearch() {
        mhaInput.value = '';
        selectedLocation = null;
        mhaDropdown.classList.add('hidden');
        clearBtn.classList.add('hidden');
        rent = 0;
        updateDisplay();
        mhaInput.focus();
    }

    mhaInput.addEventListener('focus', () => {
        mhaDropdown.classList.remove('hidden');
        let list = [];
        if(REGION === 'conus') {
            list = mhaInput.value ? DATA_BAH.filter(i => i.name.toLowerCase().includes(mhaInput.value.toLowerCase())).slice(0,50) : DATA_BAH.slice(0,50);
        } else {
            const seen = new Set();
            if(!mhaInput.value) {
               list = DATA_OHA.filter(i => { const k = i.location+i.country; if(!seen.has(k)){ seen.add(k); return true;} return false;}).slice(0,50); 
            } else {
               const q = mhaInput.value.toLowerCase();
               list = DATA_OHA.filter(i => {
                    const key = i.location + i.country;
                    if(seen.has(key)) return false;
                    if(i.location.toLowerCase().includes(q) || i.country.toLowerCase().includes(q)) { seen.add(key); return true; }
                    return false;
                }).slice(0,50);
            }
        }
        renderList(list);
        const sel = document.getElementById('selected-item');
        if(sel) sel.scrollIntoView({block: 'nearest'});
    });

    mhaInput.addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        if(q.length > 0) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');
        
        mhaDropdown.classList.remove('hidden');
        let list = [];
        if(REGION === 'conus') {
            list = DATA_BAH.filter(i => i.name.toLowerCase().includes(q)).slice(0,50);
        } else {
            const seen = new Set();
            list = DATA_OHA.filter(i => {
                const key = i.location + i.country;
                if(seen.has(key)) return false;
                if(i.location.toLowerCase().includes(q) || i.country.toLowerCase().includes(q)) { seen.add(key); return true; }
                return false;
            }).slice(0,50);
        }
        renderList(list);
    });

    function renderList(list) {
        mhaDropdown.innerHTML = '';
        if(list.length === 0) {
            mhaDropdown.innerHTML = '<div class="px-4 py-3 text-sm text-zinc-500">No results found.</div>';
            return;
        }
        list.forEach(item => {
            const div = document.createElement('div');
            let isSelected = false;
            if(selectedLocation) {
                if(REGION === 'conus' && item.name === selectedLocation.name) isSelected = true;
                if(REGION === 'oconus' && item.location === selectedLocation.location && item.country === selectedLocation.country) isSelected = true;
            }
            div.className = `px-4 py-3 cursor-pointer text-sm border-b border-zinc-100 dark:border-zinc-800/50 hover:bg-purple-50 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-300 ${isSelected ? 'bg-purple-100 dark:bg-purple-900/30 font-bold text-purple-700 dark:text-purple-200' : ''}`;
            if(isSelected) div.id = 'selected-item';

            if(REGION === 'conus') {
                div.textContent = item.name;
                div.onclick = () => { selectedLocation = item; mhaInput.value = item.name; finalizeSelection(); };
            } else {
                div.textContent = `${item.location}, ${item.country}`;
                div.onclick = () => { selectedLocation = item; mhaInput.value = `${item.location}, ${item.country}`; finalizeSelection(); };
            }
            mhaDropdown.appendChild(div);
        });
    }

    function finalizeSelection() {
        mhaDropdown.classList.add('hidden');
        updateDisplay();
    }

    document.addEventListener('click', (e) => {
        if (!document.getElementById('dropdown-container').contains(e.target)) {
            mhaDropdown.classList.add('hidden');
        }
    });

    document.getElementById('rank-select').addEventListener('change', (e) => { selectedRank = e.target.value; updateDisplay(); });
    
    document.getElementById('rent-slider').addEventListener('input', (e) => { 
        rent = parseFloat(e.target.value); 
        updateDisplay(); 
    });
    
    document.getElementById('utilities-slider').addEventListener('input', (e) => { 
        utilities = parseFloat(e.target.value);
        document.getElementById('utilities-display').textContent = formatCurrency(utilities);
        updateDisplay(); 
    });

    document.getElementById('price-slider').addEventListener('input', (e) => { 
        homePrice = parseFloat(e.target.value);
        document.getElementById('price-display').textContent = formatCurrency(homePrice);
        updateDisplay(); 
    });

    document.getElementById('rate-slider').addEventListener('input', (e) => { 
        interestRate = parseFloat(e.target.value);
        document.getElementById('rate-display').textContent = interestRate.toFixed(1) + "%";
        updateDisplay(); 
    });

    document.getElementById('down-slider').addEventListener('input', (e) => { 
        downPayment = parseFloat(e.target.value);
        document.getElementById('down-display').textContent = formatCurrency(downPayment);
        updateDisplay(); 
    });
    
    // MOUSE WHEEL LOGIC
    document.querySelectorAll('input[type="range"]').forEach(sl => {
        sl.addEventListener('wheel', e => {
            if(document.activeElement === sl || sl.matches(':hover')) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -1 : 1;
                const step = parseFloat(sl.step) || 1;
                sl.value = parseFloat(sl.value) + (delta * step);
                sl.dispatchEvent(new Event('input'));
            }
        }, {passive: false});
    });

    document.getElementById('dependents-toggle').addEventListener('click', () => {
        hasDependents = !hasDependents;
        const s = document.getElementById('dependents-slider');
        const t = document.getElementById('dependents-toggle');
        const y = t.querySelector('span:nth-child(2)');
        const n = t.querySelector('span:nth-child(1)');
        if(hasDependents) {
            s.classList.add('translate-x-[100%]'); y.classList.add('dark:text-white', 'text-purple-900'); n.classList.replace('text-zinc-600','text-zinc-400');
        } else {
            s.classList.remove('translate-x-[100%]'); y.classList.remove('dark:text-white', 'text-purple-900'); n.classList.replace('text-zinc-400','text-zinc-600');
        }
        updateDisplay();
    });

    function setCalculatorMode(m) {
        mode = m;
        const r = document.getElementById('mode-rent');
        const b = document.getElementById('mode-buy');
        const ir = document.getElementById('inputs-rent');
        const ib = document.getElementById('inputs-buy');
        if(m === 'rent') {
            r.classList.replace('text-zinc-400', 'text-purple-600'); r.classList.replace('border-transparent', 'border-purple-600');
            b.classList.replace('text-purple-600', 'text-zinc-400'); b.classList.replace('border-purple-600', 'border-transparent');
            ir.classList.remove('hidden'); ib.classList.add('hidden');
        } else {
            b.classList.replace('text-zinc-400', 'text-purple-600'); b.classList.replace('border-transparent', 'border-purple-600');
            r.classList.replace('text-purple-600', 'text-zinc-400'); r.classList.replace('border-purple-600', 'border-transparent');
            ib.classList.remove('hidden'); ir.classList.add('hidden');
        }
        updateDisplay();
    }

    (function() {
        const s = document.getElementById('rank-select');
        RANKS.forEach(r => { const o = document.createElement('option'); o.value = r.value; o.textContent = r.label; s.appendChild(o); });
        s.value = selectedRank;
        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const d = document.documentElement.classList.contains('dark');
            document.getElementById('sun-icon').classList.toggle('hidden', !d);
            document.getElementById('moon-icon').classList.toggle('hidden', d);
        });
        const d = document.documentElement.classList.contains('dark');
        document.getElementById('sun-icon').classList.toggle('hidden', !d);
        document.getElementById('moon-icon').classList.toggle('hidden', d);
        initializeData();
    })();
</script>
</body>
</html>
