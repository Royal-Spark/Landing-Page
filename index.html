<script>
    // --- START: Global Functions & Variables ---
    const SAVINGS_DATA = {
        dollarsSaved: 10605020,
        hoursSaved: 5232
    };

    function animateCounter(element, start, end, duration, prefix = '', suffix = '') {
        const startTime = performance.now();
        function updateCounter(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const currentValue = Math.floor(start + (end - start) * easeOut);
            const formattedValue = currentValue.toLocaleString();
            element.textContent = prefix + formattedValue + suffix;
            if (progress < 1) requestAnimationFrame(updateCounter);
        }
        requestAnimationFrame(updateCounter);
    }

    function initializeCounters() {
        const dollarCounter = document.getElementById('dollar-counter');
        const hoursCounter = document.getElementById('hours-counter');
        if (dollarCounter && hoursCounter) {
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    animateCounter(dollarCounter, 0, SAVINGS_DATA.dollarsSaved, 2000, '$');
                    animateCounter(hoursCounter, 0, SAVINGS_DATA.hoursSaved, 2000);
                    observer.disconnect();
                }
            }, { threshold: 0.1 });
            observer.observe(dollarCounter);
        }
    }

    function handleAudioError(audio) {
        const errorDiv = audio.parentElement.querySelector('.audio-error');
        if (errorDiv) {
            errorDiv.style.display = 'block';
        }
    }

    function fitToolButtons() {
        document.querySelectorAll('.tool-button').forEach(btn => {
            if (btn.offsetParent === null) return;
            let fontSize = 1.15;
            btn.style.fontSize = fontSize + 'rem';
            while (
                btn.scrollWidth > btn.clientWidth &&
                fontSize > 0.7
            ) {
                fontSize -= 0.02;
                btn.style.fontSize = fontSize + 'rem';
            }
        });
    }
    // --- END: Global Functions & Variables ---


    // --- Wait for the page to fully load before running scripts ---
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- Theme Switcher Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let initialTheme = savedTheme ? savedTheme : (prefersDark ? 'dark' : 'light');
        applyTheme(initialTheme);

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });

        // --- Mobile Menu Toggle Logic ---
        const menuButton = document.querySelector('.mobile-menu-button');
        const mobileMenu = document.querySelector('#mobile-menu');

        if (menuButton && mobileMenu) {
            menuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('is-open');
            });
            mobileMenu.addEventListener('click', (e) => {
                if (e.target.classList.contains('nav-link')) {
                    mobileMenu.classList.remove('is-open');
                }
            });
        }

        // --- Smooth Scrolling Logic ---
        const navLinks = document.querySelectorAll('a.nav-link[href^="#"]');
        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href');
                const targetSection = document.querySelector(targetId);
                if (targetSection) {
                    targetSection.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // --- Video Popup Logic ---
        const titleTrigger = document.querySelector('#tools .section-title');
        const videoOverlay = document.getElementById('video-popup-overlay');
        const closeBtn = document.getElementById('close-popup-btn');
        const youtubePlayer = document.getElementById('youtube-player');
        const videoSrc = 'https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&rel=0';

        if (titleTrigger && videoOverlay && closeBtn && youtubePlayer) {
            titleTrigger.addEventListener('dblclick', () => {
                window.getSelection().removeAllRanges();
                youtubePlayer.src = videoSrc;
                videoOverlay.style.display = 'flex';
            });
            const closePopup = () => {
                youtubePlayer.src = '';
                videoOverlay.style.display = 'none';
            };
            closeBtn.addEventListener('click', closePopup);
            videoOverlay.addEventListener('click', (e) => {
                if (e.target === videoOverlay) {
                    closePopup();
                }
            });
        }
        
        // --- Initial Function Calls ---
        initializeCounters();
        fitToolButtons();
    });

    // --- Add resize listener for tool buttons ---
    window.addEventListener('resize', fitToolButtons);

</script>
